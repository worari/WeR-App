// ----------------------------------------
// GLOBAL CONFIGURATION
// ----------------------------------------
const SHEET_ID = "1WR3QlzD0SxxIMh8Ggq1-Se4hBrWav-Wg0P10PV5YPkE"; // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ï‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
const SHEET_NAME = "Data";
const DRIVE_FOLDER_ID = "1-aF1AeThZvzODLIZhB7BUFCuO2P2xqqr"; // üëà ‚ÄºÔ∏è ‡∏ß‡∏≤‡∏á Folder ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
// ----------------------------------------

/**
 * ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile("index").evaluate()
    .setTitle("‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏£‡∏∏‡πà‡∏ô")
    .addMetaTag("viewport", "width=device-width, initial-scale=1.0");
}

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Google Sheet
 */
function loadData() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    if (sheet.getLastRow() < 2) {
      return []; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
    }
    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
    const values = dataRange.getValues();
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

    // ‡πÅ‡∏õ‡∏•‡∏á array ‡πÄ‡∏õ‡πá‡∏ô object
    const data = values.map(row => {
      let obj = {};
      headers.forEach((header, index) => {
        obj[header] = row[index];
      });
      return obj;
    });

    return data;
  } catch (e) {
    Logger.log(e);
    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + e.message);
  }
}

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
 * @param {object} formData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
 * @param {object} fileBlob - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (data, mimeType, fileName)
 */
function saveData(formData, fileBlob) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const uniqueIdCol = headers.indexOf("UniqueID") + 1;
    const fileIdCol = headers.indexOf("FileID") + 1;
    const imageFormulaCol = headers.indexOf("ImageFormula") + 1;
    
    let fileId = formData.FileID || "";
    let imageUrl = formData.ImageFormula ? formData.ImageFormula.match(/="([^"]+)"/)[1] : ""; // ‡∏î‡∏∂‡∏á URL ‡∏à‡∏≤‡∏Å‡∏™‡∏π‡∏ï‡∏£

    // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
    if (fileBlob && fileBlob.data) {
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      const decodedData = Utilities.base64Decode(fileBlob.data);
      const blob = Utilities.newBlob(decodedData, fileBlob.mimeType, fileBlob.fileName);
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏°‡∏µ FileID ‡πÄ‡∏î‡∏¥‡∏°) ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
      if (formData.FileID) {
        try {
          DriveApp.getFileById(formData.FileID).setTrashed(true);
        } catch (e) {
          Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö: " + e.message);
        }
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      fileId = file.getId();
      imageUrl = `https://drive.google.com/uc?id=${fileId}`;
    }

    // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ä‡∏µ‡∏ï
    formData.Timestamp = new Date();
    formData.FileID = fileId;
    formData.ImageFormula = imageUrl ? `=IMAGE("${imageUrl}")` : ""; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£ IMAGE

    // 3. ‡∏´‡∏ß‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
    const rowData = headers.map(header => formData[header] || "");

    // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï"
    if (formData.UniqueID) {
      // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ---
      const data = sheet.getDataRange().getValues();
      const rowIndex = data.findIndex(row => row[uniqueIdCol - 1] == formData.UniqueID);
      
      if (rowIndex !== -1) {
        const sheetRowIndex = rowIndex + 1; // rowIndex_0 = ‡πÅ‡∏ñ‡∏ß_1
        sheet.getRange(sheetRowIndex, 1, 1, rowData.length).setValues([rowData]);
        return JSON.stringify({ status: "success", message: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", data: formData });
      } else {
        throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö UniqueID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      }
    } else {
      // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ---
      formData.UniqueID = Utilities.getUuid(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
      rowData[uniqueIdCol - 1] = formData.UniqueID; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ID ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô rowData
      
      sheet.appendRow(rowData);
      return JSON.stringify({ status: "success", message: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", data: formData });
    }

  } catch (e) {
    Logger.log(e);
    return JSON.stringify({ status: "error", message: e.message });
  }
}

/**
 * ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * @param {string} uniqueID - ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö
 */
function deleteData(uniqueID) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const headers = data.shift(); // ‡πÄ‡∏≠‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏≠‡∏Å
    const uniqueIdColIndex = headers.indexOf("UniqueID");
    const fileIdColIndex = headers.indexOf("FileID");

    if (uniqueIdColIndex === -1) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå UniqueID");
    }

    // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID
    const rowIndex = data.findIndex(row => row[uniqueIdColIndex] == uniqueID);

    if (rowIndex !== -1) {
      const sheetRowIndex = rowIndex + 2; // +1 (index) +1 (header)
      const fileId = data[rowIndex][fileIdColIndex];

      // 1. ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Drive (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (fileId) {
        try {
          DriveApp.getFileById(fileId).setTrashed(true);
        } catch (e) {
          Logger.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå: " + e.message);
        }
      }
      
      // 2. ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô Sheet
      sheet.deleteRow(sheetRowIndex);
      
      return JSON.stringify({ status: "success", message: "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" });
    } else {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö");
    }
  } catch (e) {
    Logger.log(e);
    return JSON.stringify({ status: "error", message: e.message });
  }
}
