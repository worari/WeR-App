<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประมาณการสิทธิและสวัสดิการกำลังพล ทบ.</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons (e.g., loading spinner) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Official/Formal Theme Styles (Green, Blue, Orange) */
        body {
            font-family: 'Inter', sans-serif; /* Fallback to sans-serif if Inter is not loaded */
            @apply bg-gray-100 text-gray-800; /* Light gray background, dark text */
        }
        .official-container {
            @apply bg-white border border-blue-200 shadow-lg p-6 md:p-8 rounded-lg; /* Rounded container with subtle border */
        }
        .official-input, .official-textarea, .official-select {
            @apply bg-white text-gray-800 border border-gray-300 focus:border-blue-500 focus:ring-blue-500 rounded-md p-2 w-full; /* Rounded inputs with subtle borders */
        }
        .official-button {
            @apply bg-emerald-700 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all duration-150 ease-in-out; /* Professional green button */
        }
        .official-button-secondary {
            @apply bg-blue-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-all duration-150 ease-in-out; /* Professional blue secondary button */
        }
        .official-button-danger {
            @apply bg-red-600 text-white font-semibold py-3 px-6 rounded-md shadow-md hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition-all duration-150 ease-in-out; /* Professional red danger button */
        }
        .official-title {
            @apply text-3xl md:text-4xl font-extrabold text-blue-800 mb-6 text-center border-b-2 border-blue-400 pb-2; /* Official blue title */
        }
        .official-fieldset {
            @apply border border-gray-300 p-4 mb-6 rounded-lg bg-gray-50; /* Rounded fieldset with light background */
        }
        .official-legend {
            @apply text-xl font-bold text-blue-700 px-2 -ml-2 bg-white border border-gray-300 rounded-md; /* Official blue legend */
        }
        .official-card {
            @apply bg-white border border-gray-200 p-4 rounded-lg shadow-sm; /* Clean card style */
        }
        .official-table {
            @apply w-full text-left border-collapse;
        }
        .official-table th, .official-table td {
            @apply border border-gray-300 p-2;
        }
        .official-table th {
            @apply bg-blue-100 text-blue-800 font-semibold;
        }
        .official-table td {
            @apply bg-white text-gray-800;
        }

        /* Modal styles */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply official-container w-11/12 md:w-1/2 lg:w-1/3;
        }
        .modal-header {
            @apply text-xl font-bold text-blue-700 mb-4 border-b-2 border-blue-400 pb-2;
        }
        .modal-body {
            @apply mb-6 text-gray-700;
        }
        .modal-footer {
            @apply flex justify-end space-x-4;
        }
        .modal-close-btn {
            @apply official-button-secondary;
        }

        /* Loading spinner */
        .loading-spinner {
            @apply absolute inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <i class="fas fa-spinner fa-spin text-blue-500 text-6xl"></i>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button id="modalCloseBtn" class="official-button-secondary modal-close-btn">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="official-container w-full max-w-4xl">

        <!-- Login View -->
        <div id="loginView" class="view">
            <h1 class="official-title">เข้าสู่ระบบ</h1>
            <form id="loginForm" class="space-y-4">
                <label for="loginEmail" class="block text-gray-700">อีเมล:</label>
                <input type="email" id="loginEmail" placeholder="อีเมล" class="official-input" required>

                <label for="loginPassword" class="block text-gray-700">รหัสผ่าน:</label>
                <input type="password" id="loginPassword" placeholder="รหัสผ่าน" class="official-input" required>

                <button type="submit" class="official-button w-full">เข้าสู่ระบบ</button>
                <button type="button" id="googleLoginBtn" class="official-button-secondary w-full flex items-center justify-center space-x-2">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5">
                    <span>เข้าสู่ระบบด้วย Google</span>
                </button>
                <div id="recaptcha-container-login" class="mt-4"></div>
                <label for="loginPhone" class="block text-gray-700 mt-4">เบอร์โทรศัพท์ (สำหรับเข้าสู่ระบบ):</label>
                <input type="tel" id="loginPhone" placeholder="เช่น +66812345678" class="official-input">
                <button type="button" id="phoneLoginBtn" class="official-button-secondary w-full">เข้าสู่ระบบด้วยเบอร์โทรศัพท์</button>
                <input type="text" id="phoneOtpInput" placeholder="รหัส OTP" class="official-input hidden mt-2">
                <button type="button" id="verifyOtpBtn" class="official-button w-full hidden mt-2">ยืนยัน OTP</button>


                <p class="text-center text-gray-600 mt-4">
                    <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline">ลืมรหัสผ่าน?</a> |
                    <a href="#" id="registerLink" class="text-blue-600 hover:underline">ลงทะเบียน</a>
                </p>
                <div id="loginMessage" class="text-red-600 text-center mt-4"></div>
            </form>
        </div>

        <!-- Register View -->
        <div id="registerView" class="view hidden">
            <h1 class="official-title">ลงทะเบียน</h1>
            <form id="registerForm" class="space-y-4">
                <label for="registerEmail" class="block text-gray-700">อีเมล:</label>
                <input type="email" id="registerEmail" placeholder="อีเมล" class="official-input" required>

                <label for="registerPassword" class="block text-gray-700">รหัสผ่าน:</label>
                <input type="password" id="registerPassword" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" class="official-input" required>

                <label for="registerPhone" class="block text-gray-700 mt-4">เบอร์โทรศัพท์ (ไม่บังคับ):</label>
                <input type="tel" id="registerPhone" placeholder="เช่น +66812345678" class="official-input">

                <button type="submit" class="official-button w-full">ลงทะเบียน</button>
                <p class="text-center text-gray-600 mt-4">
                    <a href="#" id="backToLoginLink" class="text-blue-600 hover:underline">กลับไปหน้าเข้าสู่ระบบ</a>
                </p>
                <div id="registerMessage" class="text-red-600 text-center mt-4"></div>
            </form>
        </div>

        <!-- Forgot Password View -->
        <div id="forgotPasswordView" class="view hidden">
            <h1 class="official-title">ลืมรหัสผ่าน</h1>
            <form id="forgotPasswordForm" class="space-y-4">
                <label for="forgotEmail" class="block text-gray-700">อีเมล:</label>
                <input type="email" id="forgotEmail" placeholder="อีเมลที่ลงทะเบียน" class="official-input" required>

                <button type="submit" class="official-button w-full">ส่งลิงก์เปลี่ยนรหัสผ่าน</button>
                <p class="text-center text-gray-600 mt-4">
                    <a href="#" id="backToLoginFromForgotLink" class="text-blue-600 hover:underline">กลับไปหน้าเข้าสู่ระบบ</a>
                </p>
                <div id="forgotPasswordMessage" class="text-red-600 text-center mt-4"></div>
            </form>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view hidden">
            <h1 class="official-title">Dashboard</h1>
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 md:space-x-4">
                <p class="text-gray-700">ยินดีต้อนรับ, <span id="userEmail" class="font-bold text-emerald-700"></span>!</p>
                <div class="flex space-x-4">
                    <button id="goToFormBtn" class="official-button-secondary">กรอกข้อมูลสวัสดิการ</button>
                    <button id="logoutBtn" class="official-button-danger">ออกจากระบบ</button>
                </div>
            </div>

            <!-- User Profile Section -->
            <div class="official-fieldset mb-6">
                <legend class="official-legend">ข้อมูลโปรไฟล์</legend>
                <div class="space-y-2">
                    <p class="text-gray-700">UID: <span id="userUid" class="font-mono text-blue-700 text-sm"></span></p>
                    <p class="text-gray-700">อีเมล: <span id="profileEmail" class="text-blue-700"></span></p>
                    <label for="profileNationalId" class="block text-gray-700">หมายเลขบัตร ปชช.:</label>
                    <input type="text" id="profileNationalId" placeholder="กรอกหมายเลขบัตรประชาชน" class="official-input">
                    <label for="profilePhoneNumber" class="block text-gray-700">เบอร์โทรศัพท์:</label>
                    <input type="tel" id="profilePhoneNumber" placeholder="เช่น +66812345678" class="official-input">
                    <button id="saveProfileBtn" class="official-button mt-4">บันทึกโปรไฟล์</button>
                    <div id="profileMessage" class="text-red-600 mt-2"></div>
                </div>
            </div>

            <!-- Dashboard Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="official-card">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">สถานะกำลังพล</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="official-card">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">ประเภทสวัสดิการ</h3>
                    <canvas id="welfareTypeChart"></canvas>
                </div>
            </div>

            <!-- Simple Heatmap-like Table -->
            <div class="official-card mb-6">
                <h3 class="text-xl font-bold text-blue-700 mb-4">การกระจายสวัสดิการ (Heatmap-like)</h3>
                <div class="overflow-x-auto">
                    <table class="official-table">
                        <thead>
                            <tr>
                                <th>หน่วย</th>
                                <th>สวัสดิการ A</th>
                                <th>สวัสดิการ B</th>
                                <th>สวัสดิการ C</th>
                            </tr>
                        </thead>
                        <tbody id="heatmapTableBody">
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Form View -->
        <div id="formView" class="view hidden">
            <h1 class="official-title">กรอกข้อมูลสวัสดิการ</h1>
            <form id="welfareForm" class="space-y-4">
                <fieldset class="official-fieldset">
                    <legend class="official-legend">ข้อมูลกำลังพล</legend>
                    <label for="personnelId" class="block text-gray-700">รหัสกำลังพล:</label>
                    <input type="text" id="personnelId" class="official-input" required>

                    <label for="personnelName" class="block text-gray-700">ชื่อ-สกุล:</label>
                    <input type="text" id="personnelName" class="official-input" required>

                    <label for="unit" class="block text-gray-700">สังกัดหน่วย:</label>
                    <input type="text" id="unit" class="official-input">

                    <label for="status" class="block text-gray-700">สถานะกำลังพล:</label>
                    <select id="status" class="official-select">
                        <option value="active">ประจำการ</option>
                        <option value="retired">เกษียณ</option>
                        <option value="disabled">ทุพพลภาพ</option>
                        <option value="deceased">เสียชีวิต</option>
                    </select>

                    <label for="birthDate" class="block text-gray-700">วัน/เดือน/ปีเกิด:</label>
                    <input type="date" id="birthDate" class="official-input">
                </fieldset>

                <fieldset class="official-fieldset">
                    <legend class="official-legend">ข้อมูลสวัสดิการที่ได้รับ</legend>
                    <label for="welfareType" class="block text-gray-700">ประเภทสวัสดิการ:</label>
                    <select id="welfareType" class="official-select">
                        <option value="pension">บำนาญ</option>
                        <option value="medical">ค่ารักษาพยาบาล</option>
                        <option value="education">ทุนการศึกษาบุตร</option>
                        <option value="housing">สวัสดิการที่อยู่อาศัย</option>
                        <option value="disability">เงินช่วยเหลือทุพพลภาพ</option>
                        <option value="other">อื่นๆ</option>
                    </select>

                    <label for="welfareAmount" class="block text-gray-700">จำนวนเงิน (บาท):</label>
                    <input type="number" id="welfareAmount" class="official-input" value="0" min="0">

                    <label for="welfareDate" class="block text-gray-700">วันที่ได้รับ:</label>
                    <input type="date" id="welfareDate" class="official-input">

                    <label for="notes" class="block text-gray-700">หมายเหตุ:</label>
                    <textarea id="notes" rows="3" class="official-textarea"></textarea>

                    <label for="supportingDoc" class="block text-gray-700">เอกสารประกอบ (PDF/รูปภาพ):</label>
                    <input type="file" id="supportingDoc" accept=".pdf,image/*" class="official-input file:official-button-secondary file:border-none file:rounded-md file:py-2 file:px-4 file:mr-4">
                </fieldset>

                <button type="submit" class="official-button w-full">บันทึกข้อมูลสวัสดิการ</button>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4">
                    <button type="button" id="summarizeWelfareBtn" class="official-button-secondary w-full hidden">✨ สรุปข้อมูลสวัสดิการ</button>
                    <button type="button" id="suggestWelfareBtn" class="official-button-secondary w-full hidden">✨ แนะนำสวัสดิการเพิ่มเติม</button>
                </div>
                <button type="button" id="backToDashboardBtn" class="official-button-secondary w-full mt-4">กลับ Dashboard</button>
                <div id="formMessage" class="text-red-600 mt-4 text-center"></div>
                <div id="llmOutput" class="mt-4 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 hidden">
                    <h3 class="font-bold text-lg mb-2">ผลลัพธ์จาก AI:</h3>
                    <p id="llmContent"></p>
                </div>
            </form>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; // Use 10.12.2 for consistency
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, PhoneAuthProvider, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyDQ-RXl0oCcv2m-E4UdAN0EBM23Pim-CkU",
            authDomain: "wer-rta-19abb.firebaseapp.com",
            databaseURL: "https://wer-rta-19abb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wer-rta-19abb",
            storageBucket: "wer-rta-19abb.firebasestorage.app",
            messagingSenderId: "589588167770",
            appId: "1:589588167770:web:000cbdc807136d9f522c63"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global Variables
        let currentView = 'login';
        let inactivityTimeout;
        const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10 minutes in milliseconds
        let recaptchaVerifier;
        let confirmationResult; // For phone auth
        let lastSubmittedWelfareData = null; // To store data for LLM features

        // --- UI Elements ---
        const appContainer = document.getElementById('app');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const customModal = document.getElementById('customModal');
        const modalHeader = document.getElementById('modalHeader');
        const modalBody = document.getElementById('modalBody');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // Views
        const loginView = document.getElementById('loginView');
        const registerView = document.getElementById('registerView');
        const forgotPasswordView = document.getElementById('forgotPasswordView');
        const dashboardView = document.getElementById('dashboardView');
        const formView = document.getElementById('formView');

        // Login Elements
        const loginForm = document.getElementById('loginForm');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginMessage = document.getElementById('loginMessage');
        const registerLink = document.getElementById('registerLink');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const loginPhoneInput = document.getElementById('loginPhone');
        const phoneLoginBtn = document.getElementById('phoneLoginBtn');
        const phoneOtpInput = document.getElementById('phoneOtpInput');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const recaptchaContainerLogin = document.getElementById('recaptcha-container-login');


        // Register Elements
        const registerForm = document.getElementById('registerForm');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerPhoneInput = document.getElementById('registerPhone');
        const registerMessage = document.getElementById('registerMessage');
        const backToLoginLink = document.getElementById('backToLoginLink');

        // Forgot Password Elements
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const forgotEmailInput = document.getElementById('forgotEmail');
        const forgotPasswordMessage = document.getElementById('forgotPasswordMessage');
        const backToLoginFromForgotLink = document.getElementById('backToLoginFromForgotLink');

        // Dashboard Elements
        const userEmailSpan = document.getElementById('userEmail');
        const userUidSpan = document.getElementById('userUid');
        const profileEmailInput = document.getElementById('profileEmail');
        const profileNationalIdInput = document.getElementById('profileNationalId');
        const profilePhoneNumberInput = document.getElementById('profilePhoneNumber');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const profileMessage = document.getElementById('profileMessage');
        const goToFormBtn = document.getElementById('goToFormBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusChartCanvas = document.getElementById('statusChart');
        const welfareTypeChartCanvas = document.getElementById('welfareTypeChart');
        const heatmapTableBody = document.getElementById('heatmapTableBody');
        let statusChartInstance = null;
        let welfareTypeChartInstance = null;


        // Form Elements
        const welfareForm = document.getElementById('welfareForm');
        const personnelIdInput = document.getElementById('personnelId');
        const personnelNameInput = document.getElementById('personnelName');
        const unitInput = document.getElementById('unit');
        const statusSelect = document.getElementById('status');
        const birthDateInput = document.getElementById('birthDate');
        const welfareTypeSelect = document.getElementById('welfareType');
        const welfareAmountInput = document.getElementById('welfareAmount');
        const welfareDateInput = document.getElementById('welfareDate');
        const notesTextarea = document.getElementById('notes');
        const supportingDocInput = document.getElementById('supportingDoc');
        const formMessage = document.getElementById('formMessage');
        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        const summarizeWelfareBtn = document.getElementById('summarizeWelfareBtn'); // New button
        const suggestWelfareBtn = document.getElementById('suggestWelfareBtn');     // New button
        const llmOutputDiv = document.getElementById('llmOutput');
        const llmContentP = document.getElementById('llmContent');


        // --- Helper Functions ---

        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        function showModal(header, body, type = 'info') {
            modalHeader.textContent = header;
            modalBody.textContent = body;
            // You can add more styling based on type if needed
            customModal.classList.remove('hidden');
        }

        function hideModal() {
            customModal.classList.add('hidden');
        }

        function showView(viewName) {
            const views = [loginView, registerView, forgotPasswordView, dashboardView, formView];
            views.forEach(view => view.classList.add('hidden'));

            switch (viewName) {
                case 'login':
                    loginView.classList.remove('hidden');
                    // Initialize reCAPTCHA for phone login if not already done
                    if (!recaptchaVerifier) {
                        recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainerLogin, {
                            'size': 'invisible', // or 'normal' if you want it visible
                            'callback': (response) => {
                                // reCAPTCHA solved, allow signInWithPhoneNumber.
                                // You can optionally hide the reCAPTCHA container if 'size' is 'normal'
                            }
                        });
                        recaptchaVerifier.render(); // Render it
                    }
                    break;
                case 'register':
                    registerView.classList.remove('hidden');
                    break;
                case 'forgotPassword':
                    forgotPasswordView.classList.remove('hidden');
                    break;
                case 'dashboard':
                    dashboardView.classList.remove('hidden');
                    loadDashboardData(); // Load data when dashboard is shown
                    break;
                case 'form':
                    formView.classList.remove('hidden');
                    // Hide LLM buttons and output when entering form view
                    summarizeWelfareBtn.classList.add('hidden');
                    suggestWelfareBtn.classList.add('hidden');
                    llmOutputDiv.classList.add('hidden');
                    llmContentP.textContent = '';
                    break;
            }
            currentView = viewName;
        }

        function displayMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `text-center mt-4 ${type === 'error' ? 'text-red-600' : 'text-emerald-600'}`;
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(async () => {
                if (auth.currentUser) {
                    showLoading();
                    await auth.signOut();
                    hideLoading();
                    showModal('Session Expired', 'คุณถูกออกจากระบบเนื่องจากไม่มีการใช้งาน', 'info');
                    showView('login');
                }
            }, INACTIVITY_LIMIT);
        }

        // --- Gemini API Integration ---
        async function callGeminiAPI(prompt) {
            const apiKey = firebaseConfig.apiKey; // Use the same API key as Firebase
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API HTTP Error:", response.status, errorData);
                    return `เกิดข้อผิดพลาดจากเซิร์ฟเวอร์ AI: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`;
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API returned an unexpected structure:", result);
                    // Log the full result for debugging
                    return "ไม่สามารถสร้างข้อมูลได้: โครงสร้างการตอบกลับไม่ถูกต้อง หรือไม่มีเนื้อหาที่คาดหวัง";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI: ${error.message}`;
            }
        }

        // --- Firebase Authentication Handlers ---

        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userEmailSpan.textContent = user.email || user.phoneNumber || 'N/A';
                userUidSpan.textContent = user.uid;
                profileEmailInput.value = user.email || '';
                profilePhoneNumberInput.value = user.phoneNumber || '';

                // Fetch user profile from Firestore
                await fetchUserProfile(user.uid);

                showView('dashboard');
                resetInactivityTimer(); // Start timer when logged in
            } else {
                // User is signed out
                showView('login');
                clearTimeout(inactivityTimeout); // Clear timer if logged out
            }
        });

        // Email/Password Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                displayMessage(loginMessage, 'เข้าสู่ระบบสำเร็จ!', 'success');
                // onAuthStateChanged will handle view change
            } catch (error) {
                console.error("Login Error:", error);
                let errorMessage = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                }
                displayMessage(loginMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Google Login
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            showLoading();
            try {
                await signInWithPopup(auth, provider);
                displayMessage(loginMessage, 'เข้าสู่ระบบด้วย Google สำเร็จ!', 'success');
                // onAuthStateChanged will handle view change
            } catch (error) {
                console.error("Google Login Error:", error);
                let errorMessage = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบด้วย Google';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'คุณปิดหน้าต่าง Google Login';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'มีการร้องขอ Google Login ซ้ำซ้อน';
                }
                displayMessage(loginMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Phone Login (Request OTP)
        phoneLoginBtn.addEventListener('click', async () => {
            const phoneNumber = loginPhoneInput.value;
            if (!phoneNumber) {
                displayMessage(loginMessage, 'กรุณากรอกเบอร์โทรศัพท์');
                return;
            }
            showLoading();
            try {
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                phoneOtpInput.classList.remove('hidden');
                verifyOtpBtn.classList.remove('hidden');
                phoneLoginBtn.classList.add('hidden'); // Hide request button
                displayMessage(loginMessage, 'ส่งรหัส OTP ไปยังเบอร์โทรศัพท์ของคุณแล้ว', 'success');
            } catch (error) {
                console.error("Phone Login Error:", error);
                let errorMessage = 'เกิดข้อผิดพลาดในการส่ง OTP';
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage = 'รูปแบบเบอร์โทรศัพท์ไม่ถูกต้อง (เช่น +66xxxxxxxx)';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'มีการร้องขอ OTP มากเกินไป กรุณารอสักครู่';
                }
                displayMessage(loginMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Phone Login (Verify OTP)
        verifyOtpBtn.addEventListener('click', async () => {
            const otpCode = phoneOtpInput.value;
            if (!otpCode) {
                displayMessage(loginMessage, 'กรุณากรอกรหัส OTP');
                return;
            }
            showLoading();
            try {
                await confirmationResult.confirm(otpCode);
                displayMessage(loginMessage, 'เข้าสู่ระบบด้วยเบอร์โทรศัพท์สำเร็จ!', 'success');
                // onAuthStateChanged will handle view change
            } catch (error) {
                console.error("OTP Verification Error:", error);
                let errorMessage = 'รหัส OTP ไม่ถูกต้องหรือไม่ถูกต้อง';
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = 'รหัส OTP ไม่ถูกต้อง';
                }
                displayMessage(loginMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            const phoneNumber = registerPhoneInput.value;
            showLoading();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Save phone number to user profile in Firestore if provided
                if (phoneNumber) {
                    await setDoc(doc(db, 'users', user.uid), {
                        email: user.email,
                        phoneNumber: phoneNumber,
                        createdAt: serverTimestamp()
                    }, { merge: true });
                } else {
                     await setDoc(doc(db, 'users', user.uid), {
                        email: user.email,
                        createdAt: serverTimestamp()
                    }, { merge: true });
                }

                displayMessage(registerMessage, 'ลงทะเบียนสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว', 'success');
                showView('login'); // Go back to login after registration
            } catch (error) {
                console.error("Register Error:", error);
                let errorMessage = 'เกิดข้อผิดพลาดในการลงทะเบียน';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'อีเมลนี้ถูกใช้งานแล้ว';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'รหัสผ่านอ่อนเกินไป (ต้องมีอย่างน้อย 6 ตัวอักษร)';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                }
                displayMessage(registerMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Forgot Password
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = forgotEmailInput.value;
            showLoading();
            try {
                await sendPasswordResetEmail(auth, email);
                displayMessage(forgotPasswordMessage, 'ส่งลิงก์เปลี่ยนรหัสผ่านไปยังอีเมลของคุณแล้ว', 'success');
            } catch (error) {
                console.error("Forgot Password Error:", error);
                let errorMessage = 'เกิดข้อผิดพลาดในการส่งลิงก์เปลี่ยนรหัสผ่าน';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ไม่พบผู้ใช้ด้วยอีเมลนี้';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                }
                displayMessage(forgotPasswordMessage, errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
                displayMessage(loginMessage, 'ออกจากระบบสำเร็จ', 'success');
                // onAuthStateChanged will handle view change
            } catch (error) {
                console.error("Logout Error:", error);
                showModal('Error', 'เกิดข้อผิดพลาดในการออกจากระบบ', 'error');
            } finally {
                hideLoading();
            }
        });

        // --- User Profile Management ---
        async function fetchUserProfile(uid) {
            try {
                const userDocRef = doc(db, 'users', uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    profileNationalIdInput.value = userData.nationalId || '';
                    profilePhoneNumberInput.value = userData.phoneNumber || '';
                } else {
                    // Create a basic profile if it doesn't exist
                    await setDoc(userDocRef, {
                        email: auth.currentUser.email,
                        createdAt: serverTimestamp()
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                displayMessage(profileMessage, 'เกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์', 'error');
            }
        }

        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                showModal('Error', 'คุณต้องเข้าสู่ระบบก่อน', 'error');
                return;
            }
            showLoading();
            try {
                const nationalId = profileNationalIdInput.value;
                const phoneNumber = profilePhoneNumberInput.value;
                await updateDoc(doc(db, 'users', user.uid), {
                    nationalId: nationalId || null,
                    phoneNumber: phoneNumber || null,
                    updatedAt: serverTimestamp()
                });
                displayMessage(profileMessage, 'บันทึกโปรไฟล์สำเร็จ!', 'success');
            } catch (error) {
                console.error("Error saving profile:", error);
                displayMessage(profileMessage, 'เกิดข้อผิดพลาดในการบันทึกโปรไฟล์', 'error');
            } finally {
                hideLoading();
            }
        });

        // --- Form Submission ---
        welfareForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showModal('Error', 'คุณต้องเข้าสู่ระบบก่อนจึงจะบันทึกข้อมูลได้', 'error');
                return;
            }

            showLoading();
            try {
                const personnelData = {
                    personnelId: personnelIdInput.value,
                    personnelName: personnelNameInput.value,
                    unit: unitInput.value,
                    status: statusSelect.value,
                    birthDate: birthDateInput.value ? new Date(birthDateInput.value) : null,
                    welfareType: welfareTypeSelect.value,
                    welfareAmount: parseFloat(welfareAmountInput.value) || 0,
                    welfareDate: welfareDateInput.value ? new Date(welfareDateInput.value) : null,
                    notes: notesTextarea.value,
                    userId: user.uid, // Link to the user who submitted
                    timestamp: serverTimestamp()
                };

                // Handle file upload if a file is selected
                const supportingDocFile = supportingDocInput.files[0];
                if (supportingDocFile) {
                    const storageRef = ref(storage, `supporting_documents/${user.uid}/${Date.now()}_${supportingDocFile.name}`);
                    const uploadTask = await uploadBytes(storageRef, supportingDocFile);
                    const downloadURL = await getDownloadURL(uploadTask.ref);
                    personnelData.supportingDocUrl = downloadURL;
                }

                await addDoc(collection(db, 'formSubmissions'), personnelData);
                displayMessage(formMessage, 'บันทึกข้อมูลสวัสดิการสำเร็จ!', 'success');
                welfareForm.reset(); // Clear form
                supportingDocInput.value = ''; // Clear file input

                // Store the last submitted data for LLM features
                lastSubmittedWelfareData = personnelData;
                summarizeWelfareBtn.classList.remove('hidden');
                suggestWelfareBtn.classList.remove('hidden');
                llmOutputDiv.classList.add('hidden'); // Hide previous LLM output

            } catch (error) {
                console.error("Form Submission Error:", error);
                displayMessage(formMessage, `เกิดข้อผิดพลาดในการบันทึก: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // --- LLM Feature Event Listeners ---
        summarizeWelfareBtn.addEventListener('click', async () => {
            if (!lastSubmittedWelfareData) {
                showModal('ข้อผิดพลาด', 'ไม่พบข้อมูลสวัสดิการที่บันทึกไว้ล่าสุด', 'error');
                return;
            }

            showLoading();
            llmOutputDiv.classList.remove('hidden');
            llmContentP.textContent = 'กำลังสรุปข้อมูล...';
            llmOutputDiv.classList.remove('bg-red-100', 'text-red-700');
            llmOutputDiv.classList.add('bg-blue-50', 'text-blue-800');

            const data = lastSubmittedWelfareData;
            const prompt = `สรุปข้อมูลสวัสดิการของกำลังพลนี้ให้กระชับและเป็นภาษาไทย:
            รหัสกำลังพล: ${data.personnelId}
            ชื่อ-สกุล: ${data.personnelName}
            สังกัดหน่วย: ${data.unit}
            สถานะ: ${data.status}
            ประเภทสวัสดิการ: ${data.welfareType}
            จำนวนเงิน: ${data.welfareAmount} บาท
            วันที่ได้รับ: ${data.welfareDate ? new Date(data.welfareDate.seconds * 1000).toLocaleDateString('th-TH') : 'ไม่ระบุ'}
            หมายเหตุ: ${data.notes || 'ไม่มี'}`;

            const summary = await callGeminiAPI(prompt);
            llmContentP.textContent = summary;
            hideLoading();
        });

        suggestWelfareBtn.addEventListener('click', async () => {
            if (!lastSubmittedWelfareData) {
                showModal('ข้อผิดพลาด', 'ไม่พบข้อมูลสวัสดิการที่บันทึกไว้ล่าสุด', 'error');
                return;
            }

            showLoading();
            llmOutputDiv.classList.remove('hidden');
            llmContentP.textContent = 'กำลังแนะนำสวัสดิการเพิ่มเติม...';
            llmOutputDiv.classList.remove('bg-red-100', 'text-red-700');
            llmOutputDiv.classList.add('bg-blue-50', 'text-blue-800');

            const data = lastSubmittedWelfareData;
            const prompt = `จากข้อมูลกำลังพลที่มีสถานะ '${data.status}' และได้รับสวัสดิการประเภท '${data.welfareType}' จำนวน ${data.welfareAmount} บาท โปรดแนะนำสวัสดิการเพิ่มเติมที่อาจเกี่ยวข้องให้ 3-5 รายการ พร้อมคำอธิบายสั้นๆ และเหตุผลที่เกี่ยวข้อง โดยใช้ภาษาไทย`;

            const suggestions = await callGeminiAPI(prompt);
            llmContentP.textContent = suggestions;
            hideLoading();
        });


        // --- Dashboard Data & Charts ---
        async function loadDashboardData() {
            showLoading();
            try {
                const q = query(collection(db, 'formSubmissions'), orderBy('timestamp', 'desc'));

                onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push(doc.data());
                    });
                    renderCharts(data);
                    renderHeatmapTable(data);
                    hideLoading();
                }, (error) => {
                    console.error("Error listening to form submissions:", error);
                    showModal('Error', 'ไม่สามารถโหลดข้อมูล Dashboard ได้', 'error');
                    hideLoading();
                });

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showModal('Error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล Dashboard', 'error');
                hideLoading();
            }
        }

        function renderCharts(data) {
            // Destroy existing chart instances if they exist
            if (statusChartInstance) statusChartInstance.destroy();
            if (welfareTypeChartInstance) welfareTypeChartInstance.destroy();

            // Aggregate data for Status Chart
            const statusCounts = data.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});
            const statusLabels = Object.keys(statusCounts);
            const statusValues = Object.values(statusCounts);

            // Aggregate data for Welfare Type Chart
            const welfareTypeCounts = data.reduce((acc, item) => {
                acc[item.welfareType] = (acc[item.welfareType] || 0) + 1;
                return acc;
            }, {});
            const welfareT
