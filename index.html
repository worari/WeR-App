<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทำเนียบรุ่น ตท.31</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>

    <style>
        /* Custom styles for printing */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-red-800 mb-8">ทำเนียบรุ่น ตท.31</h1>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">จัดการข้อมูล</h2>
            <form id="data-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="record-id">
                <input type="hidden" id="existing-image-url">

                <div>
                    <label for="affiliation" class="block text-sm font-medium text-gray-700">สังกัด</label>
                    <select id="affiliation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                        <option>ทบ.</option><option>สป.</option><option>ทท.</option><option>สปท.</option><option>อื่นๆ</option>
                    </select>
                </div>
                <div>
                    <label for="rank" class="block text-sm font-medium text-gray-700">ยศ</label>
                    <select id="rank" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                        <option>พล.อ.</option><option>พล.ท.</option><option>พล.ต.</option><option>พ.อ.(พ.)</option><option>พ.อ.</option><option>พ.ท.</option><option>พ.ต.</option>
                    </select>
                </div>
                <div>
                    <label for="first-name" class="block text-sm font-medium text-gray-700">ชื่อ</label>
                    <input type="text" id="first-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="last-name" class="block text-sm font-medium text-gray-700">สกุล</label>
                    <input type="text" id="last-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div class="md:col-span-2">
                    <label for="position" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="corps" class="block text-sm font-medium text-gray-700">เหล่า</label>
                    <select id="corps" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                        <option>ร.</option><option>ม.</option><option>ป.</option><option>ช.</option><option>ส.</option><option>สพ.</option><option>ขส.</option><option>พธ.</option><option>สห.</option><option>ผท.</option>
                    </select>
                </div>
                <div>
                    <label for="retirement-year" class="block text-sm font-medium text-gray-700">ปีเกษียณ</label>
                    <input type="number" id="retirement-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">เบอร์โทร</label>
                    <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="province" class="block text-sm font-medium text-gray-700">จังหวัด</label>
                    <input type="text" id="province" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="district" class="block text-sm font-medium text-gray-700">อำเภอ</label>
                    <input type="text" id="district" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div class="md:col-span-1">
                    <label for="profile-image" class="block text-sm font-medium text-gray-700">รูปประจำตัว</label>
                    <input type="file" id="profile-image" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100"/>
                    <img id="image-preview" src="" class="mt-2 h-24 w-24 object-cover rounded-md hidden">
                </div>
                <div class="md:col-span-2 lg:col-span-3 flex flex-wrap gap-4 items-center justify-end">
                    <button type="submit" id="save-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">บันทึก</button>
                    <button type="button" id="update-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 hidden">แก้ไข</button>
                    <button type="button" id="clear-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">ล้างฟอร์ม</button>
                </div>
            </form>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">ทำเนียบรุ่น</h2>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input type="text" id="search-input" placeholder="ค้นหาจากชื่อ หรือ สกุล..." class="flex-grow w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                <button id="search-btn" class="w-full md:w-auto bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">ค้นหา</button>
                <button id="print-pdf-btn" class="w-full md:w-auto bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">พิมพ์รายงาน PDF</button>
                <button id="download-json-btn" class="w-full md:w-auto bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">ดาวน์โหลดข้อมูล (JSON)</button>
            </div>
            <div class="overflow-x-auto" id="print-section">
                <h3 class="text-xl font-bold text-center mb-4 hidden print-title">รายงานทำเนียบรุ่น ตท.31</h3>
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รูป</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ยศ-ชื่อ-สกุล</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตำแหน่ง</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สังกัด/เหล่า</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ติดต่อ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // <<<<<----- PASTE YOUR GOOGLE APPS SCRIPT URL HERE ----->>>>>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJkN7Ws-Do2YcxYVl-o9914T967avbFyrahPvsKBlPfcogMgknMZ1ffzqxqCfAaN8e-w/exec'; // <--- ใส่ URL ใหม่หลังจาก Deploy Code.gs

        let allData = []; 

        // --- Utility Functions ---
        const showLoading = (title) => {
            Swal.fire({
                title: title,
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        };
        
        const showSuccess = (message) => {
            Swal.fire({
                icon: 'success',
                title: 'สำเร็จ!',
                text: message,
            });
        };

        const showError = (message) => {
            Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด!',
                text: message,
            });
        };
        
        // --- Form and UI Logic ---
        function clearForm() {
            $('#data-form')[0].reset();
            $('#record-id').val('');
            $('#existing-image-url').val('');
            $('#image-preview').addClass('hidden').attr('src', '');
            $('#update-btn').addClass('hidden');
            $('#save-btn').removeClass('hidden');
        }

        $('#clear-btn').on('click', clearForm);

        $('#profile-image').on('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#image-preview').attr('src', e.target.result).removeClass('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        // --- Data Fetching and Rendering ---
        function renderTable(data) {
            const tableBody = $('#data-table-body');
            tableBody.empty();
            if (data.length === 0) {
                 tableBody.append('<tr><td colspan="6" class="text-center py-4">ไม่พบข้อมูล</td></tr>');
                 return;
            }
            data.forEach(item => {
                const row = `
                    <tr data-id="${item.id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${item.รูปภาพ || 'https://via.placeholder.com/50'}" alt="Profile" class="h-12 w-12 rounded-full object-cover">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${item.ยศ} ${item.ชื่อ}</div>
                            <div class="text-sm text-gray-500">${item.สกุล}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ตำแหน่ง || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <div class="text-sm text-gray-900">${item.สังกัด || '-'}</div>
                             <div class="text-sm text-gray-500">เหล่า: ${item.เหล่า || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>โทร: ${item.เบอร์โทร || '-'}</div>
                            <div>เกษียณ: ${item.ปีเกษียณ || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium no-print">
                            <a href="#" class="text-yellow-600 hover:text-yellow-800 edit-btn">แก้ไข</a>
                            <a href="#" class="text-red-600 hover:text-red-900 ml-4 delete-btn">ลบ</a>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
                // Attach data to the row for easy access
                $(`tr[data-id="${item.id}"]`).data('record', item);
            });
        }
        
        function loadData() {
            showLoading('กำลังโหลดข้อมูล...');
            $.ajax({
                url: GOOGLE_SCRIPT_URL + '?action=read',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    allData = data;
                    renderTable(allData);
                    Swal.close();
                },
                error: function(err) {
                    showError('ไม่สามารถโหลดข้อมูลได้');
                    console.error(err);
                }
            });
        }
        
        // --- CRUD Operations ---

        $('#data-form').on('submit', function(e) {
            e.preventDefault();
            const recordId = $('#record-id').val();
            if (recordId) {
                handleUpdate(recordId);
            } else {
                handleSave();
            }
        });

        function handleSave() {
             const fileInput = $('#profile-image')[0];
             const record = {
                affiliation: $('#affiliation').val(),
                rank: $('#rank').val(),
                firstName: $('#first-name').val(),
                lastName: $('#last-name').val(),
                position: $('#position').val(),
                corps: $('#corps').val(),
                retirementYear: $('#retirement-year').val(),
                phone: $('#phone').val(),
                province: $('#province').val(),
                district: $('#district').val()
            };

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // *** ตรวจสอบว่าใช้ 'imageData' ตรงกับที่ Server คาดหวัง ***
                    record.imageData = { 
                        base64: e.target.result,
                        name: file.name,
                        type: file.type
                    };
                    sendData('create', record);
                };
                reader.readAsDataURL(file);
            } else {
                 sendData('create', record);
            }
        }
        
        function handleUpdate(recordId) {
            const fileInput = $('#profile-image')[0];
            const record = {
                id: recordId,
                affiliation: $('#affiliation').val(),
                rank: $('#rank').val(),
                firstName: $('#first-name').val(),
                lastName: $('#last-name').val(),
                position: $('#position').val(),
                corps: $('#corps').val(),
                retirementYear: $('#retirement-year').val(),
                phone: $('#phone').val(),
                province: $('#province').val(),
                district: $('#district').val(),
                existingImageUrl: $('#existing-image-url').val()
            };

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // *** ตรวจสอบว่าใช้ 'imageData' ตรงกับที่ Server คาดหวัง ***
                    record.imageData = {
                        base64: e.target.result,
                        name: file.name,
                        type: file.type
                    };
                    sendData('update', record);
                };
                reader.readAsDataURL(file);
            } else {
                 sendData('update', record);
            }
        }

        function sendData(action, data) {
            showLoading(action === 'create' ? 'กำลังบันทึกข้อมูล...' : 'กำลังแก้ไขข้อมูล...');
            $.ajax({
                url: GOOGLE_SCRIPT_URL + `?action=${action}`,
                method: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: function(response) {
                    const res = JSON.parse(response);
                    if (res.status === 'success') {
                        showSuccess(res.message);
                        clearForm();
                        loadData(); 
                    } else {
                        showError(res.message);
                    }
                },
                error: function(err) {
                    showError('เกิดข้อผิดพลาดในการส่งข้อมูล');
                    console.error(err);
                }
            });
        }
        
        // Edit Button Handler
        $('#data-table-body').on('click', '.edit-btn', function(e) {
            e.preventDefault();
            const record = $(this).closest('tr').data('record');
            
            $('#record-id').val(record.id);
            $('#affiliation').val(record.สังกัด);
            $('#rank').val(record.ยศ);
            $('#first-name').val(record.ชื่อ);
            $('#last-name').val(record.สกุล);
            $('#position').val(record.ตำแหน่ง);
            $('#corps').val(record.เหล่า);
            $('#retirement-year').val(record.ปีเกษียณ);
            $('#phone').val(record.เบอร์โทร);
            $('#province').val(record.จังหวัด);
            $('#district').val(record.อำเภอ);
            $('#existing-image-url').val(record.รูปภาพ);

            if (record.รูปภาพ) {
                $('#image-preview').attr('src', record.รูปภาพ).removeClass('hidden');
            } else {
                $('#image-preview').addClass('hidden');
            }

            $('#save-btn').addClass('hidden');
            $('#update-btn').removeClass('hidden');
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        });

        // Delete Button Handler
        $('#data-table-body').on('click', '.delete-btn', function(e) {
            e.preventDefault();
            const recordId = $(this).closest('tr').data('record').id;
            
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: "คุณจะไม่สามารถกู้คืนข้อมูลนี้ได้!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                     showLoading('กำลังลบข้อมูล...');
                     $.ajax({
                        url: GOOGLE_SCRIPT_URL + '?action=delete',
                        method: 'POST',
                        data: JSON.stringify({ id: recordId }),
                        contentType: 'application/json',
                        success: function(response) {
                            const res = JSON.parse(response);
                            if (res.status === 'success') {
                                showSuccess(res.message);
                                loadData();
                            } else {
                                showError(res.message);
                            }
                        },
                        error: function() {
                            showError('เกิดข้อผิดพลาดในการลบข้อมูล');
                        }
                    });
                }
            });
        });

        // Search Button Handler
        $('#search-btn').on('click', function() {
            const keyword = $('#search-input').val().toLowerCase();
            if (!keyword) {
                renderTable(allData); 
                return;
            }
            showLoading('กำลังค้นหา...');
            const filteredData = allData.filter(item => {
                const fullName = `${item.ชื่อ} ${item.สกุล}`.toLowerCase();
                return fullName.includes(keyword);
            });
            renderTable(filteredData);
            Swal.close();
            Swal.fire({
                icon: 'info',
                title: 'ผลการค้นหา',
                text: `พบข้อมูล ${filteredData.length} รายการ`
            });
        });

        $('#search-input').on('keyup', function(e){
            if(e.key === 'Enter') $('#search-btn').click();
        });

        // --- Export and Print Buttons ---
        
        $('#download-json-btn').on('click', function() {
            if (allData.length === 0) {
                showError('ไม่มีข้อมูลสำหรับดาวน์โหลด');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ทำเนียบรุ่นตท31.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showSuccess('สร้างไฟล์ JSON เรียบร้อยแล้ว!');
        });

        $('#print-pdf-btn').on('click', function() {
             if (allData.length === 0) {
                showError('ไม่มีข้อมูลสำหรับพิมพ์');
                return;
            }
            $('.print-title').removeClass('hidden'); 
            window.print();
            $('.print-title').addClass('hidden'); 
        });

        // --- Initial Load ---
        loadData();
    });
    </script>
</body>
</html>
