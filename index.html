<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modern Form & Timeline with Login & Animations</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <!-- Animate on Scroll Library -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <style>
    .timeline-item {
      position: relative;
      padding-left: 2rem;
      margin-bottom: 1.5rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0; top: 0.3rem;
      width: 0.75rem; height: 0.75rem;
      background: #0d6efd; border-radius: 50%;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <!-- Login Section -->
    <div id="user-signed-out" class="text-center">
      <h2>กรุณาเข้าสู่ระบบ</h2>
      <button id="btn-login" class="btn btn-primary mb-4">Login with Email</button>
    </div>
    <div id="user-signed-in" class="d-none">
      <div class="mb-3 text-end">
        <span id="user-email" class="me-3"></span>
        <button id="btn-logout" class="btn btn-outline-secondary">Logout</button>
      </div>
      <!-- Form Section -->
      <h2 class="mb-4">กรอกข้อมูล & อัปโหลดไฟล์</h2>
      <form id="contactForm" class="mb-5">
        <div class="mb-3">
          <label class="form-label">ชื่อ-นามสกุล</label>
          <input type="text" name="name" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">อีเมล</label>
          <input type="email" name="email" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">ข้อความ</label>
          <textarea name="message" rows="3" class="form-control"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">ไฟล์แนบ</label>
          <input type="file" name="file" class="form-control" />
        </div>
        <div class="g-recaptcha mb-3" data-sitekey="6Lcn1CErAAAAAFCpe3-Euxer-2ZyxX011Z2XJ_2B"></div>
        <button type="submit" class="btn btn-primary">ส่งข้อมูล</button>
      </form>

      <!-- Timeline Section -->
      <hr />
      <h3>Timeline ผลลัพธ์</h3>
      <ul id="timeline" class="timeline list-unstyled"></ul>
    </div>
  </div>

  <!-- Firebase Login Modal -->
  <div class="modal fade" id="modal-login" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="loginEmail" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" id="loginPass" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" id="btn-show-register" class="btn btn-link">Register</button>
          </form>
          <form id="registerForm" class="d-none">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="regEmail" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" id="regPass" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">Register</button>
            <button type="button" id="btn-show-login" class="btn btn-link">Back to Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.4.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <!-- AOS Animation -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    // Initialize AOS
    AOS.init({ duration: 800, once: true });

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBwWlf9q-VqT6WzlBsSMJCHPEJjR0Pi0Ek",
      authDomain: "sittiapp-58246.firebaseapp.com",
      projectId: "sittiapp-58246",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const loginModal = new bootstrap.Modal(document.getElementById('modal-login'));
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userSignedOut = document.getElementById('user-signed-out');
    const userSignedIn = document.getElementById('user-signed-in');
    const userEmailSpan = document.getElementById('user-email');

    // Auth State Listener
    auth.onAuthStateChanged(user => {
      if (user) {
        userEmailSpan.textContent = user.email;
        userSignedOut.classList.add('d-none');
        userSignedIn.classList.remove('d-none');
        loadTimeline();
      } else {
        userSignedIn.classList.add('d-none');
        userSignedOut.classList.remove('d-none');
      }
    });

    // Show login modal
    btnLogin.addEventListener('click', () => loginModal.show());
    btnLogout.addEventListener('click', () => auth.signOut());

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPass').value;
      try { await auth.signInWithEmailAndPassword(email, pass); loginModal.hide(); }
      catch(err) { alert('Login error: ' + err.message); }
    });
    document.getElementById('btn-show-register').addEventListener('click', () => {
      document.getElementById('loginForm').classList.add('d-none');
      document.getElementById('registerForm').classList.remove('d-none');
    });

    // Register form
    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('regEmail').value;
      const pass = document.getElementById('regPass').value;
      try { await auth.createUserWithEmailAndPassword(email, pass); loginModal.hide(); }
      catch(err) { alert('Register error: ' + err.message); }
    });
    document.getElementById('btn-show-login').addEventListener('click', () => {
      document.getElementById('registerForm').classList.add('d-none');
      document.getElementById('loginForm').classList.remove('d-none');
    });

    // Existing form & timeline code (with authentication check)
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyw1b1VyG-8zUB1cCttYvKiJcEC13upirzljzCT68OTaGVyGc8I9xdC4ReTmgo7lik/exec';
    async function toBase64(file) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result.split(',')[1]);
        reader.onerror = err => rej(err);
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('contactForm').addEventListener('submit', async e => {
      e.preventDefault(); const form = e.target;
      const data = { name: form.name.value, email: form.email.value,
        message: form.message.value, token: grecaptcha.getResponse() };
      const fileInput = form.file.files[0];
      if (fileInput) {
        data.fileName = fileInput.name; data.fileMime = fileInput.type;
        data.fileData = await toBase64(fileInput);
      }
      try {
        const res = await fetch(WEBAPP_URL, { method: 'POST',
          body: JSON.stringify(data), headers: {'Content-Type':'application/json'} });
        const result = await res.json();
        if (result.status==='success') {
          status.innerHTML = '<div class="alert alert-success">ส่งข้อมูลเรียบร้อย!</div>';
          form.reset(); grecaptcha.reset(); loadTimeline();
        } else throw result.message;
      } catch(err) {
        status.innerHTML = '<div class="alert alert-danger">Error: '+err+'</div>';
      }
    });

    async function loadTimeline() {
      const res = await fetch(WEBAPP_URL);
      const items = await res.json();
      const ul = document.getElementById('timeline');
      ul.innerHTML = '';
      items.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))
        .forEach(i=>{
          const li = document.createElement('li');
          li.className = 'timeline-item';
          // AOS animation attribute
          li.setAttribute('data-aos', 'fade-up');
          li.innerHTML = `
            <small>${new Date(i.timestamp).toLocaleString('th-TH')}</small>
            <h5>${i.name} (${i.email})</h5>
            <p>${i.message}</p>
            ${i.fileUrl?`<p><a href=\"${i.fileUrl}\" target=\"_blank\">ดาวน์โหลดไฟล์</a></p>`:''}
          `;
          ul.appendChild(li);
        });
    }
  </script>
</body>
</html>
